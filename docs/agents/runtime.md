# Runtime Runbook

CLI entrypoint:

```bash
python -m src.agents.runtime --query "What are FY2025 productivity measures?"
```

## Useful Commands

Run manual showcase demos:

```bash
bash scripts/demo_runtime_queries.sh
```

`scripts/` is intentionally used for runnable demos and future utility scripts (keeps tooling in one standard place).
Canonical query catalog: `docs/agents/sample_queries.md`.
Run any one query manually with:

```bash
python -m src.agents.runtime --query "<paste query from docs/agents/sample_queries.md>"
```

Run with overrides:

```bash
python -m src.agents.runtime \
  --query "What are FY2025 productivity measures?" \
  --top-k 30 \
  --top-n 8
```

## Required Environment

Core:
- `OPENAI_API_KEY`
- `MILVUS_URI`
- `MILVUS_TOKEN`
- `AGENT_MAX_CYCLES`
- `AGENT_CONFIDENCE_STRONG`
- `AGENT_CONFIDENCE_MEDIUM`
- `AGENT_CONFIDENCE_LOW`
- `AGENT_CONFIDENCE_VERY_LOW`
- BM25 artifact at `artifacts/bm25_model.pkl` (generated by ingestion)
- `AGENT_OPENAI_MODEL` (legacy/general; synthesis/reflection-specific knobs are preferred)

MCP:
- `AGENT_MCP_ENABLED`
- `AGENT_MCP_STRICT`
- `AGENT_MCP_TIMEOUT_SECONDS`
- `AGENT_MCP_RETRIEVE_TOOL`
- `AGENT_MCP_RERANK_TOOL`
- `AGENT_MCP_SYNTHESIZE_TOOL`
- `AGENT_MCP_REFLECT_TOOL`

Planner + filtering:
- `AGENT_PLANNER_MODEL`
- `AGENT_PLANNER_TEMPERATURE`
- `AGENT_FY_FILTERING_ENABLED`
- `AGENT_RECENT_YEAR_WINDOW` (default: 5 years)
- `AGENT_CORPUS_LATEST_FY` (default: 2025) — treated as the corpus “current year”

Hybrid retrieval + rerank:
- `AGENT_HYBRID_MERGE_STRATEGY` (`rrf`)
- `AGENT_HYBRID_RRF_K`
- `AGENT_CROSS_ENCODER_MODEL`
- `AGENT_RERANK_CANDIDATE_LIMIT`
- `AGENT_RETRIEVE_RECENCY_BOOST`
- `AGENT_RERANK_RECENCY_BOOST`

Guardrails:
- `AGENT_GUARDRAILS_ENABLED`
- `AGENT_GUARDRAILS_INPUT_POLICY`
- `AGENT_GUARDRAILS_OUTPUT_POLICY`

Synthesis + reflection LLM tuning:
- `AGENT_SYNTHESIS_MODEL`
- `AGENT_SYNTHESIS_TEMPERATURE`
- `AGENT_REFLECTION_MODEL`
- `AGENT_REFLECTION_TEMPERATURE`

Tracing:
- `LANGCHAIN_TRACING_V2`
- `LANGCHAIN_PROJECT`
- `LANGCHAIN_API_KEY`
- optional `LANGCHAIN_ENDPOINT`

## Tuning Model

- Most operational knobs come from environment-backed settings in `src/agents/core/config.py`.
- Confidence-band cutoffs are environment-backed in `src/agents/core/config.py` (not user-facing API inputs).
- Manager loop safety fuse is internal via `AGENT_MAX_CYCLES` in `src/agents/core/config.py`.
- Synthesis/reflection model and temperature are developer/ops knobs from `src/agents/core/config.py` and are not user API inputs.

## Runtime Output

The CLI prints:
- confidence
- state history
- final reason
- answer
- full trace JSON

Note:
- Planner may mark a query as incoherent; in that case manager returns an immediate polite rejection before specialist/tool execution.
- For coherent queries, manager runs a single deterministic pass (`synthesize+reflect`) before applying confidence-band handling.
- Answer text comes from synthesis output; applicability/uncertainty come from final reflection output.
- `confidence` and `final reason` remain separate metadata fields.
- When year intent is ambiguous, retrieval does not filter by year; rerank still favors recent years via a soft boost.

## Failure Modes

- Startup readiness failure returns exit code `2` with `startup_error=MCP readiness failed: ...`.
- Guardrail terminal path includes `guardrail_event` in trace and returns safe reply.
- Missing BM25 artifact or cross-encoder load failure blocks hybrid retrieval/rerank (strict mode fails at startup).
